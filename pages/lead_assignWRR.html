<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRMçº¿ç´¢åˆ†é…ç³»ç»Ÿ V2.0 - æ™ºèƒ½æƒé‡ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; }
        .highlight { animation: pulse 1s ease-out; }
        @keyframes pulse { 0% { background-color: #fef9c3; } 100% { background-color: transparent; } }
        
        /* æ‚¬åœå¡ç‰‡æ ·å¼ */
        .staff-card {
            position: absolute;
            z-index: 1000;
            display: none;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            width: 280px;
            padding: 16px;
            border: 1px solid #e5e7eb;
        }
        
        /* é”€å”®å›¢é˜Ÿé…ç½®è¡¨æ ¼è¡Œé«˜åº¦ */
        #team-table tr {
            height: 48.5px;
        }
        
        .staff-card.show {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .staff-name-hover {
            position: relative;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: all 0.2s;
        }
        
        .staff-name-hover:hover {
            text-decoration-color: #3b82f6;
            color: #3b82f6;
        }
        
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="max-w-full mx-auto p-6">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">CRMçº¿ç´¢åˆ†é…ç³»ç»Ÿ V2.0</h1>
        <p class="text-gray-600 mt-2">æ™ºèƒ½æƒé‡ç®¡ç† + å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³• (å…±36äºº)</p>
    </header>

    <!-- æ¨¡æ‹Ÿæ§åˆ¶å™¨ - ç§»åˆ°é¡µé¢ä¸Šéƒ¨ -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4 text-center">æ¨¡æ‹Ÿæ§åˆ¶</h2>
        <div class="grid grid-cols-3 md:grid-cols-6 gap-3 max-w-4xl mx-auto">
            <button onclick="simulate(1)" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 text-sm">åˆ†é… 1 æ¡</button>
            <button onclick="simulate(10)" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 text-sm">åˆ†é… 10 æ¡</button>
            <button onclick="simulate(50)" class="bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 text-sm">åˆ†é… 50 æ¡</button>
            <button onclick="simulate(100)" class="bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 text-sm">åˆ†é… 100 æ¡</button>
            <button onclick="simulate(200)" class="bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600 text-sm">åˆ†é… 200 æ¡</button>
            <button onclick="reset()" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 text-sm">é‡ç½®ç»Ÿè®¡</button>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
        <!-- å·¦ä¾§ï¼šå›¢é˜Ÿé…ç½® -->
        <div class="space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">é”€å”®å›¢é˜Ÿé…ç½®</h2>
                    <div class="flex items-center gap-4">
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button id="flat-view-btn" onclick="switchView('flat')" 
                                    class="px-3 py-1 rounded-md text-sm transition-all duration-200 bg-blue-500 text-white">
                                å¹³é“ºè§†å›¾
                            </button>
                            <button id="group-view-btn" onclick="switchView('group')" 
                                    class="px-3 py-1 rounded-md text-sm transition-all duration-200 text-gray-600 hover:bg-gray-200">
                                åˆ†ç»„è§†å›¾
                            </button>
                        </div>
                        <button id="toggle-collapse-btn" onclick="toggleCollapse()" 
                                class="bg-purple-500 text-white px-3 py-1 rounded-lg hover:bg-purple-600 text-sm hidden">
                            ğŸ“Š éƒ¨é—¨æ¦‚è§ˆ
                        </button>
                        <button id="add-user" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">+ æ–°å¢é”€å”®</button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr class="text-sm text-gray-600" id="team-table-header">
                                <th class="p-3 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable('name')">
                                    å§“å <span id="sort-name" class="ml-1">â‡…</span>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortTable('department')" id="department-header">
                                    éƒ¨é—¨ <span id="sort-department" class="ml-1">â‡…</span>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortTable('level')">
                                    èŒçº§ <span id="sort-level" class="ml-1">â‡…</span>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortTable('weight')">
                                    æƒé‡ <span id="sort-weight" class="ml-1">â‡…</span>
                                </th>
                                <th class="p-3 text-center">æƒé‡ç™¾åˆ†æ¯”</th>
                                <th class="p-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="team-table">
                            <!-- åŠ¨æ€ç”Ÿæˆé”€å”®å‘˜è¡Œ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
                    <p><strong>æƒé‡è¯´æ˜ï¼š</strong>é»˜è®¤æƒé‡ä¸º10ï¼Œå¯è®¾ç½®1-100èŒƒå›´å†…çš„æƒé‡å€¼</p>
                    <p><strong>ç™¾åˆ†æ¯”è®¡ç®—ï¼š</strong>æœ€åä¸€ä½é”€å”®çš„ç™¾åˆ†æ¯”è‡ªåŠ¨è°ƒæ•´ç¡®ä¿æ€»å’Œä¸º100%</p>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå®æ—¶çŠ¶æ€ -->
        <div class="space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4">åˆ†é…çŠ¶æ€</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr class="text-sm text-gray-600">
                                <th class="p-3 text-left">å§“å</th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortStatusTable('department')">
                                    éƒ¨é—¨ <span id="status-sort-department" class="ml-1">â‡…</span>
                                </th>
                                <th class="p-3 text-center">èŒçº§</th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortStatusTable('weight')">
                                    è®¾å®šæƒé‡ <span id="status-sort-weight" class="ml-1">â‡…</span>
                                </th>
                                <th class="p-3 text-center">åŠ¨æ€æƒé‡</th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortStatusTable('leadCount')">
                                    å·²åˆ†é…æ¡æ•° <span id="status-sort-leadCount" class="ml-1">â‡…</span>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortStatusTable('leadRatio')">
                                    è·å¾—çº¿ç´¢å æ¯” <span id="status-sort-leadRatio" class="ml-1">â‡…</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="status-panel">
                            <!-- åŠ¨æ€ç”ŸæˆçŠ¶æ€è¡Œ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4">åˆ†é…æ—¥å¿—</h2>
                <div id="log-panel" class="overflow-y-auto bg-gray-50 p-3 rounded-lg" style="height: 512px;">
                    <p class="text-gray-500 text-center">æš‚æ— åˆ†é…è®°å½•</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// æ ¹æ®æƒé‡è®¡ç®—èŒçº§
function calculateLevel(weight) {
    if (weight >= 30) return 'L3';
    if (weight >= 15) return 'L2';
    return 'L1';
}

// ç”Ÿæˆéšæœºä¸šç»©æ•°æ®
function generateRandomPerformance() {
    const availableGroups = [
        '3-å¸‚åœºå¤–æŠ•è¡¨å•',
        '4-ç™¾åº¦SEM',
        '7-é¢†åˆ¸',
        'å¿«å•†é€šè¡¨å•åœ¨çº¿',
        'å¸‚åœºè¡¨å•æŠ•æ”¾',
        'é›†è®­è¥ä¸“é¡¹æŠ•æ”¾',
        '26å¼€å­¦å­£ç«™å†…åŠ å¾®',
        '26å¼€å­¦å­£ç«™å¤–åŠ å¾®',
        '26å®šé‡‘è®¡ç®—æœº',
        '26å®šé‡‘ç”µæ°”',
        'ä½“éªŒè¯¾æŠ•æ”¾è‡ªåŠ¨åˆ†é…1v1'
    ];
    
    // éšæœºé€‰æ‹©1-3ä¸ªåˆ†é…ç»„
    const groupCount = Math.floor(Math.random() * 3) + 1; // 1-3ä¸ª
    const selectedGroups = [];
    const shuffledGroups = [...availableGroups].sort(() => Math.random() - 0.5);
    
    for (let i = 0; i < groupCount; i++) {
        selectedGroups.push(shuffledGroups[i]);
    }
    
    return {
        monthlyPerformance: Math.floor(Math.random() * 33) + 8, // 8-40ä¸‡
        monthlyDeals: Math.floor(Math.random() * 7) + 1, // 1-7
        monthlyLeads: Math.floor(Math.random() * 201) + 100, // 100-300æ¡
        conversionRate: (Math.random() * 2.5 + 0.5).toFixed(1), // 0.5-3.0%
        assignGroup: selectedGroups.join('ã€') // ç”¨é¡¿å·åˆ†éš”å¤šä¸ªåˆ†é…ç»„
    };
}

// å…¨å±€çŠ¶æ€ç®¡ç†
let salesTeam = [];

// åˆå§‹åŒ–é”€å”®å›¢é˜Ÿæ•°æ®
function initializeSalesTeam() {
    const staffData = [
        // é”€å”®ä¸€éƒ¨
        { name: 'å¼ å°æ˜', department: 'é”€å”®ä¸€éƒ¨' },
        { name: 'æå°çº¢', department: 'é”€å”®ä¸€éƒ¨' },
        { name: 'ç‹å°å', department: 'é”€å”®ä¸€éƒ¨' },
        // é”€å”®äºŒéƒ¨
        { name: 'åˆ˜å°å¼º', department: 'é”€å”®äºŒéƒ¨' },
        { name: 'é™ˆå°å†›', department: 'é”€å”®äºŒéƒ¨' },
        { name: 'èµµå°å³°', department: 'é”€å”®äºŒéƒ¨' },
        // ååŒ—åŒº
        { name: 'å¼ å°ä¸ƒ', department: 'ååŒ—åŒº' },
        { name: 'æå°å…«', department: 'ååŒ—åŒº' },
        { name: 'ç‹å°ä¹', department: 'ååŒ—åŒº' },
        { name: 'åˆ˜å°å', department: 'ååŒ—åŒº' },
        { name: 'é™ˆå°åä¸€', department: 'ååŒ—åŒº' },
        { name: 'èµµå°åäºŒ', department: 'ååŒ—åŒº' },
        { name: 'å­™å°åä¸‰', department: 'ååŒ—åŒº' },
        { name: 'å‘¨å°åå››', department: 'ååŒ—åŒº' },
        { name: 'å´å°åäº”', department: 'ååŒ—åŒº' },
        // åä¸­åŒº
        { name: 'éƒ‘å°åå…­', department: 'åä¸­åŒº' },
        { name: 'ç‹å°åä¸ƒ', department: 'åä¸­åŒº' },
        { name: 'æå°åå…«', department: 'åä¸­åŒº' },
        { name: 'å¼ å°åä¹', department: 'åä¸­åŒº' },
        { name: 'åˆ˜å°äºŒå', department: 'åä¸­åŒº' },
        { name: 'é™ˆå°äºŒåä¸€', department: 'åä¸­åŒº' },
        { name: 'èµµå°äºŒåäºŒ', department: 'åä¸­åŒº' },
        { name: 'å­™å°äºŒåä¸‰', department: 'åä¸­åŒº' },
        { name: 'å‘¨å°äºŒåå››', department: 'åä¸­åŒº' },
        { name: 'å´å°äºŒåäº”', department: 'åä¸­åŒº' },
        { name: 'é’±å°äºŒåå…­', department: 'åä¸­åŒº' },
        { name: 'é»„å°äºŒåä¸ƒ', department: 'åä¸­åŒº' },
        // è¥¿å—åŒº
        { name: 'æå°äºŒåå…«', department: 'è¥¿å—åŒº' },
        { name: 'å¼ å°äºŒåä¹', department: 'è¥¿å—åŒº' },
        { name: 'åˆ˜å°ä¸‰å', department: 'è¥¿å—åŒº' },
        // è¥¿åŒ—åŒº
        { name: 'é™ˆå°ä¸‰åä¸€', department: 'è¥¿åŒ—åŒº' },
        { name: 'èµµå°ä¸‰åäºŒ', department: 'è¥¿åŒ—åŒº' },
        { name: 'å­™å°ä¸‰åä¸‰', department: 'è¥¿åŒ—åŒº' },
        // è¿è¥éƒ¨
        { name: 'å‘¨å°ä¸‰åå››', department: 'è¿è¥éƒ¨' },
        { name: 'å´å°ä¸‰åäº”', department: 'è¿è¥éƒ¨' },
        // æ•™å­¦éƒ¨
        { name: 'éƒ‘å°ä¸‰åå…­', department: 'æ•™å­¦éƒ¨' }
    ];

    salesTeam = staffData.map((staff, index) => ({
        id: index + 1,
        name: staff.name,
        weight: 10, // é»˜è®¤æƒé‡ä¸º10
        department: staff.department,
        level: calculateLevel(10), // L1çº§ï¼ˆæƒé‡10 < 15ï¼‰
        currentWeight: 0,
        leadCount: 0,
        ...generateRandomPerformance()
    }));
    
    // é»˜è®¤æŒ‰éƒ¨é—¨æ’åº
    sortConfig.column = 'department';
    sortConfig.direction = 'asc';
    applySorting();
}

let leadCounter = 0;
let logs = [];
let sortConfig = { column: null, direction: null }; // æ’åºé…ç½®ï¼šcolumnå’Œdirection
let statusSortConfig = { column: 'weight', direction: 'desc' }; // å³ä¾§åˆ†é…çŠ¶æ€è¡¨æ ¼çš„æ’åºé…ç½®ï¼Œé»˜è®¤æŒ‰è®¾å®šæƒé‡é™åº
let currentView = 'flat'; // å½“å‰è§†å›¾æ¨¡å¼ï¼š'flat' æˆ– 'group'
let isCollapsed = false; // æ˜¯å¦å¤„äºæŠ˜å çŠ¶æ€

// è®¡ç®—æƒé‡ç™¾åˆ†æ¯”
function calculatePercentages() {
    if (salesTeam.length === 0) return [];
    
    const totalWeight = salesTeam.reduce((sum, user) => sum + user.weight, 0);
    const percentages = [];
    let accumulatedPercentage = 0;
    
    // è®¡ç®—å‰n-1ä¸ªç”¨æˆ·çš„ç™¾åˆ†æ¯”
    for (let i = 0; i < salesTeam.length - 1; i++) {
        const percentage = (salesTeam[i].weight / totalWeight) * 100;
        percentages.push(percentage);
        accumulatedPercentage += percentage;
    }
    
    // æœ€åä¸€ä¸ªç”¨æˆ·çš„ç™¾åˆ†æ¯” = 100% - å‰é¢æ‰€æœ‰ç”¨æˆ·çš„ç™¾åˆ†æ¯”æ€»å’Œ
    if (salesTeam.length > 0) {
        percentages.push(100 - accumulatedPercentage);
    }
    
    return percentages;
}

// å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³• - æ ¸å¿ƒå®ç°
function assignLead() {
    if (salesTeam.length === 0) return null;
    
    let bestCandidate = null;
    let totalWeight = 0;
    
    // 1. æ›´æ–°æ¯ä¸ªé”€å”®çš„å½“å‰æƒé‡ï¼Œæ‰¾å‡ºæœ€å¤§æƒé‡è€…
    salesTeam.forEach(user => {
        user.currentWeight += user.weight;
        totalWeight += user.weight;
        
        if (!bestCandidate || user.currentWeight > bestCandidate.currentWeight) {
            bestCandidate = user;
        }
    });
    
    // 2. å‡å°‘è¢«é€‰ä¸­è€…çš„å½“å‰æƒé‡
    if (bestCandidate) {
        bestCandidate.currentWeight -= totalWeight;
        bestCandidate.leadCount++;
        leadCounter++;
        
        // 3. è®°å½•æ—¥å¿—
        logs.unshift({
            id: leadCounter,
            assignee: bestCandidate.name,
            timestamp: new Date().toLocaleTimeString(),
            userId: bestCandidate.id
        });
        
        if (logs.length > 50) logs.pop(); // ä¿æŒæ—¥å¿—é•¿åº¦
    }
    
    return bestCandidate;
}

// æ¨¡æ‹Ÿåˆ†é…
function simulate(count) {
    for (let i = 0; i < count; i++) {
        assignLead();
    }
    renderAll();
}

// é‡ç½®ç»Ÿè®¡
function reset() {
    salesTeam.forEach(user => {
        user.currentWeight = 0;
        user.leadCount = 0;
    });
    leadCounter = 0;
    logs = [];
    renderAll();
}

// æ·»åŠ é”€å”®
function addUser() {
    const newId = Math.max(...salesTeam.map(u => u.id), 0) + 1;
    const defaultWeight = 10;
    salesTeam.push({
        id: newId,
        name: `é”€å”®${newId}`,
        weight: defaultWeight,
        department: 'é”€å”®ä¸€éƒ¨',
        level: calculateLevel(defaultWeight),
        currentWeight: 0,
        leadCount: 0,
        ...generateRandomPerformance()
    });
    renderAll();
}

// åˆ é™¤é”€å”®
function removeUser(id) {
    salesTeam = salesTeam.filter(user => user.id !== id);
    renderAll();
}

// æ›´æ–°é”€å”®ä¿¡æ¯
function updateUser(id, field, value) {
    const user = salesTeam.find(u => u.id === id);
    if (user) {
        if (field === 'weight') {
            const weight = parseFloat(value);
            if (weight >= 1 && weight <= 100) {
                user[field] = weight;
                // æƒé‡æ”¹å˜æ—¶è‡ªåŠ¨æ›´æ–°èŒçº§
                user.level = calculateLevel(weight);
            }
        } else {
            user[field] = value;
        }
        renderAll();
    }
}

// æ˜¾ç¤ºå‘˜å·¥å¡ç‰‡
function showStaffCard(event, user) {
    // éšè—æ‰€æœ‰å…¶ä»–å¡ç‰‡
    document.querySelectorAll('.staff-card').forEach(card => {
        card.classList.remove('show');
    });
    
    const card = document.getElementById(`staff-card-${user.id}`);
    if (card) {
        const rect = event.target.getBoundingClientRect();
        
        // å…ˆè®¾ç½®transformä¸ºnoneï¼Œé¿å…åŠ¨ç”»å†²çª
        card.style.transform = 'none';
        
        // åŸºäºå§“åä½ç½®å‘å³åç§»80px
        let leftPos = rect.left + 80;
        let topPos = rect.top + window.scrollY;
        
        // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå³è¾¹ç•Œï¼Œå¦‚æœè¶…å‡ºåˆ™è°ƒæ•´ä½ç½®
        if (leftPos + 280 > window.innerWidth) { // å¡ç‰‡å®½åº¦280px
            leftPos = window.innerWidth - 280 - 20; // ç¡®ä¿ä¸è¶…å‡ºçª—å£ï¼Œç•™20pxè¾¹è·
        }
        
        // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå·¦è¾¹ç•Œ
        if (leftPos < 20) {
            leftPos = 20; // æœ€å°å·¦è¾¹è·
        }
        
        // è®¾ç½®ä½ç½®
        card.style.left = leftPos + 'px';
        card.style.top = topPos + 'px';
        
        // æœ€åæ˜¾ç¤ºå¡ç‰‡
        card.classList.add('show');
    }
}

// éšè—å‘˜å·¥å¡ç‰‡
function hideStaffCard(user) {
    const card = document.getElementById(`staff-card-${user.id}`);
    if (card) {
        card.classList.remove('show');
    }
}

// è§†å›¾åˆ‡æ¢åŠŸèƒ½
function switchView(viewType) {
    currentView = viewType;
    
    // æ›´æ–°æŒ‰é’®æ ·å¼
    const flatBtn = document.getElementById('flat-view-btn');
    const groupBtn = document.getElementById('group-view-btn');
    const collapseBtn = document.getElementById('toggle-collapse-btn');
    
    if (viewType === 'flat') {
        flatBtn.className = 'px-3 py-1 rounded-md text-sm transition-all duration-200 bg-blue-500 text-white';
        groupBtn.className = 'px-3 py-1 rounded-md text-sm transition-all duration-200 text-gray-600 hover:bg-gray-200';
        // å¹³é“ºè§†å›¾ä¸‹éšè—æŠ˜å æŒ‰é’®
        collapseBtn.classList.add('hidden');
        isCollapsed = false;
    } else {
        flatBtn.className = 'px-3 py-1 rounded-md text-sm transition-all duration-200 text-gray-600 hover:bg-gray-200';
        groupBtn.className = 'px-3 py-1 rounded-md text-sm transition-all duration-200 bg-blue-500 text-white';
        // åˆ†ç»„è§†å›¾ä¸‹æ˜¾ç¤ºæŠ˜å æŒ‰é’®
        collapseBtn.classList.remove('hidden');
        updateCollapseButtonText();
    }
    
    // æ›´æ–°è¡¨å¤´æ ·å¼
    const deptHeader = document.getElementById('department-header');
    if (viewType === 'group') {
        // åˆ†ç»„è§†å›¾ä¸‹ï¼Œéƒ¨é—¨åˆ—ä¸å¯æ’åº
        deptHeader.className = 'p-3 text-center text-gray-400';
        deptHeader.onclick = null;
    } else {
        // å¹³é“ºè§†å›¾ä¸‹ï¼Œéƒ¨é—¨åˆ—å¯æ’åº
        deptHeader.className = 'p-3 text-center cursor-pointer hover:bg-gray-100';
        deptHeader.onclick = () => sortTable('department');
    }
    
    // é‡æ–°æ¸²æŸ“è¡¨æ ¼
    renderTeamTable();
}

// åˆ‡æ¢æŠ˜å çŠ¶æ€
function toggleCollapse() {
    isCollapsed = !isCollapsed;
    updateCollapseButtonText();
    renderTeamTable();
}

// æ›´æ–°æŠ˜å æŒ‰é’®æ–‡æœ¬
function updateCollapseButtonText() {
    const collapseBtn = document.getElementById('toggle-collapse-btn');
    if (isCollapsed) {
        collapseBtn.innerHTML = 'ğŸ“‹ è¯¦ç»†åˆ—è¡¨';
        collapseBtn.className = 'bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 text-sm';
    } else {
        collapseBtn.innerHTML = 'ğŸ“Š éƒ¨é—¨æ¦‚è§ˆ';
        collapseBtn.className = 'bg-purple-500 text-white px-3 py-1 rounded-lg hover:bg-purple-600 text-sm';
    }
}

// æ¸²æŸ“å›¢é˜Ÿé…ç½®è¡¨æ ¼
function renderTeamTable() {
    const percentages = calculatePercentages();
    const tbody = document.getElementById('team-table');
    
    if (currentView === 'flat') {
        // å¹³é“ºè§†å›¾ - åŸæœ‰é€»è¾‘
        tbody.innerHTML = salesTeam.map((user, index) => `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-3 font-medium text-gray-900">
                    <span class="staff-name-hover"
                          onmouseenter="showStaffCard(event, ${JSON.stringify(user).replace(/"/g, '&quot;')})"
                          onmouseleave="hideStaffCard(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                        ${user.name}
                    </span>
                </td>
                <td class="p-3 text-center text-orange-600 font-semibold">${user.department}</td>
                <td class="p-3 text-center text-purple-600 font-semibold">${user.level}</td>
                <td class="p-3 text-center">
                    <input type="number" value="${user.weight}" step="1" min="1" max="100"
                           onchange="updateUser(${user.id}, 'weight', this.value)"
                           class="w-24 p-2 border rounded text-center text-blue-600 font-semibold bg-white text-sm">
                </td>
                <td class="p-3 text-center">
                    <span class="font-semibold ${index === salesTeam.length - 1 ? 'text-red-600' : 'text-blue-600'}">
                        ${percentages[index]?.toFixed(1) || 0}%
                    </span>
                    ${index === salesTeam.length - 1 ? '<div class="text-xs text-red-500">(è‡ªåŠ¨è°ƒæ•´)</div>' : ''}
                </td>
                <td class="p-3 text-center">
                    <button onclick="removeUser(${user.id})" 
                            class="text-red-500 hover:text-red-700 p-2 rounded hover:bg-red-50 font-bold" 
                            title="åˆ é™¤">
                        Ã—
                    </button>
                </td>
            </tr>
        `).join('');
    } else {
        // åˆ†ç»„è§†å›¾ - æŒ‰éƒ¨é—¨åˆ†ç»„
        const departments = ['é”€å”®ä¸€éƒ¨', 'é”€å”®äºŒéƒ¨', 'ååŒ—åŒº', 'åä¸­åŒº', 'è¥¿å—åŒº', 'è¥¿åŒ—åŒº', 'è¿è¥éƒ¨', 'æ•™å­¦éƒ¨'];
        let groupedHTML = '';
        
        if (isCollapsed) {
            // æŠ˜å æ¨¡å¼ï¼šåªæ˜¾ç¤ºéƒ¨é—¨ç»Ÿè®¡
            departments.forEach(dept => {
                const deptUsers = salesTeam.filter(user => user.department === dept);
                if (deptUsers.length === 0) return;
                
                // è®¡ç®—éƒ¨é—¨ç»Ÿè®¡
                const deptTotalWeight = deptUsers.reduce((sum, user) => sum + user.weight, 0);
                const deptTotalLeads = deptUsers.reduce((sum, user) => sum + user.leadCount, 0);
                const deptAvgWeight = deptUsers.length > 0 ? (deptTotalWeight / deptUsers.length).toFixed(1) : 0;
                const levelStats = deptUsers.reduce((stats, user) => {
                    stats[user.level] = (stats[user.level] || 0) + 1;
                    return stats;
                }, {});
                
                const levelStatsText = Object.entries(levelStats)
                    .map(([level, count]) => `${level}:${count}`)
                    .join(' | ');
                
                // éƒ¨é—¨æ¦‚è§ˆè¡Œ
                groupedHTML += `
                    <tr class="bg-gradient-to-r from-blue-50 to-purple-50 border-b-2 border-blue-200 hover:from-blue-100 hover:to-purple-100">
                        <td class="p-4 font-bold text-gray-900 text-lg">
                            <div class="flex items-center">
                                <span class="text-orange-600 mr-2">ğŸ“Š</span>
                                <span>${dept}</span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-sm font-semibold">
                                ${deptUsers.length}äºº
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="text-purple-600 font-semibold text-sm">
                                ${levelStatsText}
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="text-blue-600 font-semibold">
                                æ€»è®¡: ${deptTotalWeight}<br>
                                <span class="text-xs text-gray-500">å¹³å‡: ${deptAvgWeight}</span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="text-green-600 font-semibold text-sm">
                                ${((deptTotalWeight / salesTeam.reduce((sum, user) => sum + user.weight, 0)) * 100).toFixed(1)}%
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-semibold">
                                ${deptTotalLeads}æ¡
                            </div>
                        </td>
                    </tr>
                `;
            });
        } else {
            // å±•å¼€æ¨¡å¼ï¼šæ˜¾ç¤ºè¯¦ç»†äººå‘˜ä¿¡æ¯
            departments.forEach(dept => {
                const deptUsers = salesTeam.filter(user => user.department === dept);
                if (deptUsers.length === 0) return;
                
                // éƒ¨é—¨åˆ†ç»„æ ‡é¢˜è¡Œ
                groupedHTML += `
                    <tr class="bg-gray-100 border-b-2 border-gray-300">
                        <td colspan="6" class="p-3 font-bold text-gray-800 text-lg">
                            <span class="text-orange-600">${dept}</span> (${deptUsers.length}äºº)
                        </td>
                    </tr>
                `;
                
                // è¯¥éƒ¨é—¨çš„å‘˜å·¥è¡Œ
                deptUsers.forEach((user, index) => {
                    const globalIndex = salesTeam.findIndex(u => u.id === user.id);
                    groupedHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3 font-medium text-gray-900 pl-8">
                                <span class="staff-name-hover"
                                      onmouseenter="showStaffCard(event, ${JSON.stringify(user).replace(/"/g, '&quot;')})"
                                      onmouseleave="hideStaffCard(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                                    ${user.name}
                                </span>
                            </td>
                            <td class="p-3 text-center text-orange-600 font-semibold">${user.department}</td>
                            <td class="p-3 text-center text-purple-600 font-semibold">${user.level}</td>
                            <td class="p-3 text-center">
                                <input type="number" value="${user.weight}" step="1" min="1" max="100"
                                       onchange="updateUser(${user.id}, 'weight', this.value)"
                                       class="w-24 p-2 border rounded text-center text-blue-600 font-semibold bg-white text-sm">
                            </td>
                            <td class="p-3 text-center">
                                <span class="font-semibold ${globalIndex === salesTeam.length - 1 ? 'text-red-600' : 'text-blue-600'}">
                                    ${percentages[globalIndex]?.toFixed(1) || 0}%
                                </span>
                                ${globalIndex === salesTeam.length - 1 ? '<div class="text-xs text-red-500">(è‡ªåŠ¨è°ƒæ•´)</div>' : ''}
                            </td>
                            <td class="p-3 text-center">
                                <button onclick="removeUser(${user.id})" 
                                        class="text-red-500 hover:text-red-700 p-2 rounded hover:bg-red-50 font-bold" 
                                        title="åˆ é™¤">
                                    Ã—
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });
        }
        
        tbody.innerHTML = groupedHTML;
    }
    
    // æ·»åŠ å‘˜å·¥å¡ç‰‡
    renderStaffCards();
}

// æ¸²æŸ“å‘˜å·¥å¡ç‰‡
function renderStaffCards() {
    const existingCards = document.querySelectorAll('.staff-card');
    existingCards.forEach(card => card.remove());
    
    salesTeam.forEach(user => {
        const card = document.createElement('div');
        card.id = `staff-card-${user.id}`;
        card.className = 'staff-card';
        card.style.transform = 'none'; // ç¡®ä¿æ²¡æœ‰é»˜è®¤çš„transform
        card.innerHTML = `
            <div class="flex items-start gap-3 mb-3">
                <div class="avatar">
                    ${user.name.charAt(0)}
                </div>
                <div class="flex-1">
                    <h3 class="font-bold text-lg text-gray-900">${user.name}</h3>
                    <p class="text-sm text-gray-500">${user.department} Â· ${user.level}çº§</p>
                </div>
            </div>
            
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">æœ¬æœˆä¸šç»©ï¼š</span>
                    <span class="font-semibold text-green-600">${user.monthlyPerformance}ä¸‡</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">æœ¬æœˆå·²æˆäº¤ï¼š</span>
                    <span class="font-semibold text-blue-600">${user.monthlyDeals}å•</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">æœ¬æœˆæ–°åˆ†çº¿ç´¢ï¼š</span>
                    <span class="font-semibold text-purple-600">${user.monthlyLeads}æ¡</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">åŠ¨æ€è½¬åŒ–ç‡ï¼š</span>
                    <span class="font-semibold text-orange-600">${user.conversionRate}%</span>
                </div>
                <div class="pt-2 border-t">
                    <div class="text-gray-600 text-xs mb-1">æ‰€åœ¨åˆ†é…ç»„ï¼š</div>
                    <div class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs font-medium leading-relaxed">
                        ${user.assignGroup}
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(card);
    });
}

// æ¸²æŸ“çŠ¶æ€é¢æ¿
function renderStatus() {
    const tbody = document.getElementById('status-panel');
    
    // è·å–æ’åºåçš„å›¢é˜Ÿæ•°æ®
    let sortedTeam = [...salesTeam];
    
    if (statusSortConfig.column && statusSortConfig.direction) {
        sortedTeam.sort((a, b) => {
            let valueA = a[statusSortConfig.column];
            let valueB = b[statusSortConfig.column];
            
                            // ç‰¹æ®Šå¤„ç†éƒ¨é—¨æ’åº
                if (statusSortConfig.column === 'department') {
                    const departmentOrder = { 
                        'é”€å”®ä¸€éƒ¨': 1, 'é”€å”®äºŒéƒ¨': 2, 'ååŒ—åŒº': 3, 'åä¸­åŒº': 4, 
                        'è¥¿å—åŒº': 5, 'è¥¿åŒ—åŒº': 6, 'è¿è¥éƒ¨': 7, 'æ•™å­¦éƒ¨': 8 
                    };
                    valueA = departmentOrder[valueA] || 999;
                    valueB = departmentOrder[valueB] || 999;
                }
            // ç‰¹æ®Šå¤„ç†æƒé‡æ’åº
            else if (statusSortConfig.column === 'weight') {
                valueA = parseFloat(valueA);
                valueB = parseFloat(valueB);
            }
            // ç‰¹æ®Šå¤„ç†çº¿ç´¢å æ¯”æ’åº
            else if (statusSortConfig.column === 'leadRatio') {
                const totalLeadCount = salesTeam.reduce((sum, user) => sum + user.leadCount, 0);
                valueA = totalLeadCount > 0 ? (a.leadCount / totalLeadCount * 100) : 0;
                valueB = totalLeadCount > 0 ? (b.leadCount / totalLeadCount * 100) : 0;
            }
            
            if (valueA < valueB) {
                return statusSortConfig.direction === 'asc' ? -1 : 1;
            }
            if (valueA > valueB) {
                return statusSortConfig.direction === 'asc' ? 1 : -1;
            }
            return 0;
        });
    }
    
    // è®¡ç®—æ±‡æ€»æ•°æ®
    const totalWeight = salesTeam.reduce((sum, user) => sum + user.weight, 0);
    const totalCurrentWeight = salesTeam.reduce((sum, user) => sum + user.currentWeight, 0);
    const totalLeadCount = salesTeam.reduce((sum, user) => sum + user.leadCount, 0);
    const userCount = salesTeam.length;
    
    const userRows = sortedTeam.map(user => {
        const isLastAssigned = logs.length > 0 && logs[0].userId === user.id;
        const weightPercentage = totalWeight > 0 ? (user.weight / totalWeight * 100).toFixed(1) : '0.0';
        const leadRatio = totalLeadCount > 0 ? (user.leadCount / totalLeadCount * 100).toFixed(1) : '0.0';
        
        return `
            <tr class="border-b ${isLastAssigned ? 'highlight bg-yellow-50' : 'hover:bg-gray-50'}">
                <td class="p-3 font-medium text-gray-900">
                    <span class="staff-name-hover"
                          onmouseenter="showStaffCard(event, ${JSON.stringify(user).replace(/"/g, '&quot;')})"
                          onmouseleave="hideStaffCard(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                        ${user.name}
                    </span>
                </td>
                <td class="p-3 text-center text-orange-600 font-semibold">${user.department}</td>
                <td class="p-3 text-center text-purple-600 font-semibold">${user.level}</td>
                <td class="p-3 text-center text-blue-600 font-semibold text-sm">${user.weight} (${weightPercentage}%)</td>
                <td class="p-3 text-center font-mono text-sm ${user.currentWeight >= 0 ? 'text-green-600' : 'text-red-600'}">${Math.round(user.currentWeight)}</td>
                <td class="p-3 text-center font-bold text-blue-700">${user.leadCount}</td>
                <td class="p-3 text-center font-bold text-purple-700">
                    ${leadRatio}%
                </td>
            </tr>
        `;
    }).join('');
    
    // æ±‡æ€»è¡Œ
    const summaryRow = `
        <tr class="border-t-2 border-gray-400 bg-blue-50 font-semibold">
            <td class="p-3 font-bold text-gray-900">æ±‡æ€» (${userCount}äºº)</td>
            <td class="p-3 text-center text-gray-600">-</td>
            <td class="p-3 text-center text-gray-600">-</td>
            <td class="p-3 text-center font-bold text-blue-700 text-sm">${totalWeight.toFixed(1)} (100%)</td>
            <td class="p-3 text-center font-bold font-mono text-sm ${totalCurrentWeight >= 0 ? 'text-green-700' : 'text-red-700'}">${Math.round(totalCurrentWeight)}</td>
            <td class="p-3 text-center font-bold text-blue-700">${totalLeadCount}</td>
            <td class="p-3 text-center font-bold text-purple-700">
                100%
            </td>
        </tr>
    `;
    
    tbody.innerHTML = userRows + summaryRow;
}

// æ¸²æŸ“æ—¥å¿—
function renderLogs() {
    const panel = document.getElementById('log-panel');
    
    if (logs.length === 0) {
        panel.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— åˆ†é…è®°å½•</p>';
        return;
    }
    
    panel.innerHTML = logs.map(log => `
        <div class="mb-2 p-2 bg-white rounded border-l-4 border-blue-500">
            <span class="font-medium">çº¿ç´¢ #${log.id}</span> â†’ 
            <span class="text-blue-600 font-semibold">${log.assignee}</span>
            <span class="text-gray-400 text-sm float-right">${log.timestamp}</span>
        </div>
    `).join('');
    
    panel.scrollTop = 0;
}

// åº”ç”¨æ’åºçš„æ ¸å¿ƒå‡½æ•°
function applySorting() {
    let sortedTeam = [...salesTeam];
    
    if (currentView === 'group') {
        // åˆ†ç»„è§†å›¾ï¼šåœ¨å„éƒ¨é—¨å†…éƒ¨æ’åº
        if (sortConfig.column && sortConfig.direction && sortConfig.column !== 'department') {
            const departments = ['é”€å”®ä¸€éƒ¨', 'é”€å”®äºŒéƒ¨', 'ååŒ—åŒº', 'åä¸­åŒº', 'è¥¿å—åŒº', 'è¥¿åŒ—åŒº', 'è¿è¥éƒ¨', 'æ•™å­¦éƒ¨'];
            let newSortedTeam = [];
            
            departments.forEach(dept => {
                const deptUsers = sortedTeam.filter(user => user.department === dept);
                if (deptUsers.length === 0) return;
                
                deptUsers.sort((a, b) => {
                    let valueA = a[sortConfig.column];
                    let valueB = b[sortConfig.column];
                    
                    if (sortConfig.column === 'level') {
                        const levelOrder = { 'L1': 1, 'L2': 2, 'L3': 3 };
                        valueA = levelOrder[valueA] || 999;
                        valueB = levelOrder[valueB] || 999;
                    } else if (typeof valueA === 'string') {
                        valueA = valueA.toLowerCase();
                        valueB = valueB.toLowerCase();
                    }
                    
                    if (valueA < valueB) {
                        return sortConfig.direction === 'asc' ? -1 : 1;
                    }
                    if (valueA > valueB) {
                        return sortConfig.direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
                
                newSortedTeam.push(...deptUsers);
            });
            
            sortedTeam = newSortedTeam;
        } else {
            // åˆ†ç»„è§†å›¾ä¸‹é»˜è®¤æŒ‰éƒ¨é—¨+IDæ’åº
            const departments = ['é”€å”®ä¸€éƒ¨', 'é”€å”®äºŒéƒ¨', 'ååŒ—åŒº', 'åä¸­åŒº', 'è¥¿å—åŒº', 'è¥¿åŒ—åŒº', 'è¿è¥éƒ¨', 'æ•™å­¦éƒ¨'];
            let newSortedTeam = [];
            departments.forEach(dept => {
                const deptUsers = sortedTeam.filter(user => user.department === dept);
                deptUsers.sort((a, b) => a.id - b.id);
                newSortedTeam.push(...deptUsers);
            });
            sortedTeam = newSortedTeam;
        }
    } else {
        // å¹³é“ºè§†å›¾ï¼šå…¨å±€æ’åº
        if (sortConfig.column && sortConfig.direction) {
            sortedTeam.sort((a, b) => {
                let valueA = a[sortConfig.column];
                let valueB = b[sortConfig.column];
                
                // ç‰¹æ®Šå¤„ç†éƒ¨é—¨æ’åº
                if (sortConfig.column === 'department') {
                    const departmentOrder = { 
                        'é”€å”®ä¸€éƒ¨': 1, 'é”€å”®äºŒéƒ¨': 2, 'ååŒ—åŒº': 3, 'åä¸­åŒº': 4, 
                        'è¥¿å—åŒº': 5, 'è¥¿åŒ—åŒº': 6, 'è¿è¥éƒ¨': 7, 'æ•™å­¦éƒ¨': 8 
                    };
                    valueA = departmentOrder[valueA] || 999;
                    valueB = departmentOrder[valueB] || 999;
                } else if (sortConfig.column === 'level') {
                    // ç‰¹æ®Šå¤„ç†èŒçº§æ’åº
                    const levelOrder = { 'L1': 1, 'L2': 2, 'L3': 3 };
                    valueA = levelOrder[valueA] || 999;
                    valueB = levelOrder[valueB] || 999;
                } else if (typeof valueA === 'string') {
                    // å¤„ç†å…¶ä»–å­—ç¬¦ä¸²ç±»å‹çš„æ’åº
                    valueA = valueA.toLowerCase();
                    valueB = valueB.toLowerCase();
                }
                
                if (valueA < valueB) {
                    return sortConfig.direction === 'asc' ? -1 : 1;
                }
                if (valueA > valueB) {
                    return sortConfig.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        } else {
            // å¦‚æœæ²¡æœ‰æ’åºé…ç½®ï¼Œåˆ™æŒ‰IDæ’åºï¼ˆé»˜è®¤é¡ºåºï¼‰
            sortedTeam.sort((a, b) => a.id - b.id);
        }
    }
    
    salesTeam = sortedTeam;
}

// è¡¨æ ¼æ’åºåŠŸèƒ½
function sortTable(column) {
    // åœ¨åˆ†ç»„è§†å›¾ä¸‹ï¼Œä¸å…è®¸æŒ‰éƒ¨é—¨æ’åºï¼ˆå› ä¸ºå·²ç»æŒ‰éƒ¨é—¨åˆ†ç»„ï¼‰
    if (currentView === 'group' && column === 'department') {
        return;
    }
    
    // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ’åºåˆ—ï¼Œåˆ™åˆ‡æ¢æ’åºæ–¹å‘
    if (sortConfig.column === column) {
        if (sortConfig.direction === 'asc') {
            sortConfig.direction = 'desc';
        } else if (sortConfig.direction === 'desc') {
            sortConfig.direction = null;
            sortConfig.column = null;
        } else {
            sortConfig.direction = 'asc';
        }
    } else {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æ–°åˆ—ï¼Œåˆ™è®¾ç½®ä¸ºå‡åº
        sortConfig.column = column;
        sortConfig.direction = 'asc';
    }
    
    applySorting();
    updateSortIndicators();
    renderAll();
}

// åˆ†é…çŠ¶æ€è¡¨æ ¼æ’åºåŠŸèƒ½
function sortStatusTable(column) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ’åºåˆ—ï¼Œåˆ™åˆ‡æ¢æ’åºæ–¹å‘
    if (statusSortConfig.column === column) {
        if (statusSortConfig.direction === 'asc') {
            statusSortConfig.direction = 'desc';
        } else if (statusSortConfig.direction === 'desc') {
            statusSortConfig.direction = null;
            statusSortConfig.column = null;
        } else {
            statusSortConfig.direction = 'asc';
        }
    } else {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æ–°åˆ—ï¼Œåˆ™è®¾ç½®ä¸ºå‡åº
        statusSortConfig.column = column;
        statusSortConfig.direction = 'asc';
    }
    
    updateStatusSortIndicators();
    renderStatus();
}

// æ›´æ–°å·¦ä¾§å›¢é˜Ÿé…ç½®æ’åºæŒ‡ç¤ºå™¨
function updateSortIndicators() {
    const indicators = ['name', 'department', 'level', 'weight'];
    
    indicators.forEach(indicator => {
        const element = document.getElementById(`sort-${indicator}`);
        if (element) {
            // åœ¨åˆ†ç»„è§†å›¾ä¸‹ï¼Œéƒ¨é—¨åˆ—ä¸æ˜¾ç¤ºæ’åºæŒ‡ç¤ºå™¨ï¼ˆå› ä¸ºå·²ç»æŒ‰éƒ¨é—¨åˆ†ç»„ï¼‰
            if (currentView === 'group' && indicator === 'department') {
                element.textContent = '';
                return;
            }
            
            if (sortConfig.column === indicator) {
                if (sortConfig.direction === 'asc') {
                    element.textContent = 'â†‘';
                    element.style.color = '#3b82f6';
                } else if (sortConfig.direction === 'desc') {
                    element.textContent = 'â†“';
                    element.style.color = '#3b82f6';
                }
            } else {
                element.textContent = 'â‡…';
                element.style.color = '#9ca3af';
            }
        }
    });
}

// æ›´æ–°å³ä¾§åˆ†é…çŠ¶æ€æ’åºæŒ‡ç¤ºå™¨
function updateStatusSortIndicators() {
    const indicators = ['department', 'weight', 'leadCount', 'leadRatio'];
    
    indicators.forEach(indicator => {
        const element = document.getElementById(`status-sort-${indicator}`);
        if (element) {
            if (statusSortConfig.column === indicator) {
                if (statusSortConfig.direction === 'asc') {
                    element.textContent = 'â†‘';
                    element.style.color = '#3b82f6';
                } else if (statusSortConfig.direction === 'desc') {
                    element.textContent = 'â†“';
                    element.style.color = '#3b82f6';
                }
            } else {
                element.textContent = 'â‡…';
                element.style.color = '#9ca3af';
            }
        }
    });
}

// æ¸²æŸ“æ‰€æœ‰ç»„ä»¶
function renderAll() {
    renderTeamTable();
    renderStatus();
    renderLogs();
    updateSortIndicators();
    updateStatusSortIndicators();
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    initializeSalesTeam(); // åˆå§‹åŒ–é”€å”®å›¢é˜Ÿæ•°æ®
    document.getElementById('add-user').addEventListener('click', addUser);
    renderAll();
});

// ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—æ‰€æœ‰å¡ç‰‡
document.addEventListener('click', (event) => {
    if (!event.target.closest('.staff-name-hover') && !event.target.closest('.staff-card')) {
        document.querySelectorAll('.staff-card').forEach(card => {
            card.classList.remove('show');
        });
    }
});
</script>

</body>
</html> 