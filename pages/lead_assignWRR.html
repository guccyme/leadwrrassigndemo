<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM线索分配系统 V2.0 - 智能权重管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; }
        .highlight { animation: pulse 1s ease-out; }
        @keyframes pulse { 0% { background-color: #fef9c3; } 100% { background-color: transparent; } }
        
        /* 悬停卡片样式 */
        .staff-card {
            position: absolute;
            z-index: 1000;
            display: none;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            width: 280px;
            padding: 16px;
            border: 1px solid #e5e7eb;
        }
        
        /* 销售团队配置表格行高度 */
        #team-table tr {
            height: 48.5px;
        }
        
        .staff-card.show {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .staff-name-hover {
            position: relative;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: all 0.2s;
        }
        
        .staff-name-hover:hover {
            text-decoration-color: #3b82f6;
            color: #3b82f6;
        }
        
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="max-w-full mx-auto p-6">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">CRM线索分配系统 V2.0</h1>
        <p class="text-gray-600 mt-2">智能权重管理 + 平滑加权轮询算法 (共36人)</p>
    </header>

    <!-- 模拟控制器 - 移到页面上部 -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4 text-center">模拟控制</h2>
        <div class="grid grid-cols-3 md:grid-cols-6 gap-3 max-w-4xl mx-auto">
            <button onclick="simulate(1)" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 text-sm">分配 1 条</button>
            <button onclick="simulate(10)" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 text-sm">分配 10 条</button>
            <button onclick="simulate(50)" class="bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 text-sm">分配 50 条</button>
            <button onclick="simulate(100)" class="bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 text-sm">分配 100 条</button>
            <button onclick="simulate(200)" class="bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600 text-sm">分配 200 条</button>
            <button onclick="reset()" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 text-sm">重置统计</button>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
        <!-- 左侧：团队配置 -->
        <div class="space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">销售团队配置</h2>
                    <div class="flex items-center gap-4">
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button id="flat-view-btn" onclick="switchView('flat')" 
                                    class="px-3 py-1 rounded-md text-sm transition-all duration-200 bg-blue-500 text-white">
                                平铺视图
                            </button>
                            <button id="group-view-btn" onclick="switchView('group')" 
                                    class="px-3 py-1 rounded-md text-sm transition-all duration-200 text-gray-600 hover:bg-gray-200">
                                分组视图
                            </button>
                        </div>
                        <button id="toggle-collapse-btn" onclick="toggleCollapse()" 
                                class="bg-purple-500 text-white px-3 py-1 rounded-lg hover:bg-purple-600 text-sm hidden">
                            📊 部门概览
                        </button>
                        <button id="add-user" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">+ 新增销售</button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr class="text-sm text-gray-600" id="team-table-header">
                                <th class="p-3 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable('name')">
                                    姓名 <span id="sort-name" class="ml-1">⇅</span>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortTable('department')" id="department-header">
                                    部门 <span id="sort-department" class="ml-1">⇅</span>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortTable('level')">
                                    职级 <span id="sort-level" class="ml-1">⇅</span>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortTable('weight')">
                                    权重 <span id="sort-weight" class="ml-1">⇅</span>
                                </th>
                                <th class="p-3 text-center">权重百分比</th>
                                <th class="p-3 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="team-table">
                            <!-- 动态生成销售员行 -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
                    <p><strong>权重说明：</strong>默认权重为10，可设置1-100范围内的权重值</p>
                    <p><strong>百分比计算：</strong>最后一位销售的百分比自动调整确保总和为100%</p>
                </div>
            </div>
        </div>

        <!-- 右侧：实时状态 -->
        <div class="space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4">分配状态</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr class="text-sm text-gray-600">
                                <th class="p-3 text-left">姓名</th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortStatusTable('department')">
                                    部门 <span id="status-sort-department" class="ml-1">⇅</span>
                                </th>
                                <th class="p-3 text-center">职级</th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortStatusTable('weight')">
                                    设定权重 <span id="status-sort-weight" class="ml-1">⇅</span>
                                </th>
                                <th class="p-3 text-center">动态权重</th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortStatusTable('leadCount')">
                                    已分配条数 <span id="status-sort-leadCount" class="ml-1">⇅</span>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortStatusTable('leadRatio')">
                                    获得线索占比 <span id="status-sort-leadRatio" class="ml-1">⇅</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="status-panel">
                            <!-- 动态生成状态行 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4">分配日志</h2>
                <div id="log-panel" class="overflow-y-auto bg-gray-50 p-3 rounded-lg" style="height: 512px;">
                    <p class="text-gray-500 text-center">暂无分配记录</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 根据权重计算职级
function calculateLevel(weight) {
    if (weight >= 30) return 'L3';
    if (weight >= 15) return 'L2';
    return 'L1';
}

// 生成随机业绩数据
function generateRandomPerformance() {
    const availableGroups = [
        '3-市场外投表单',
        '4-百度SEM',
        '7-领券',
        '快商通表单在线',
        '市场表单投放',
        '集训营专项投放',
        '26开学季站内加微',
        '26开学季站外加微',
        '26定金计算机',
        '26定金电气',
        '体验课投放自动分配1v1'
    ];
    
    // 随机选择1-3个分配组
    const groupCount = Math.floor(Math.random() * 3) + 1; // 1-3个
    const selectedGroups = [];
    const shuffledGroups = [...availableGroups].sort(() => Math.random() - 0.5);
    
    for (let i = 0; i < groupCount; i++) {
        selectedGroups.push(shuffledGroups[i]);
    }
    
    return {
        monthlyPerformance: Math.floor(Math.random() * 33) + 8, // 8-40万
        monthlyDeals: Math.floor(Math.random() * 7) + 1, // 1-7
        monthlyLeads: Math.floor(Math.random() * 201) + 100, // 100-300条
        conversionRate: (Math.random() * 2.5 + 0.5).toFixed(1), // 0.5-3.0%
        assignGroup: selectedGroups.join('、') // 用顿号分隔多个分配组
    };
}

// 全局状态管理
let salesTeam = [];

// 初始化销售团队数据
function initializeSalesTeam() {
    const staffData = [
        // 销售一部
        { name: '张小明', department: '销售一部' },
        { name: '李小红', department: '销售一部' },
        { name: '王小华', department: '销售一部' },
        // 销售二部
        { name: '刘小强', department: '销售二部' },
        { name: '陈小军', department: '销售二部' },
        { name: '赵小峰', department: '销售二部' },
        // 华北区
        { name: '张小七', department: '华北区' },
        { name: '李小八', department: '华北区' },
        { name: '王小九', department: '华北区' },
        { name: '刘小十', department: '华北区' },
        { name: '陈小十一', department: '华北区' },
        { name: '赵小十二', department: '华北区' },
        { name: '孙小十三', department: '华北区' },
        { name: '周小十四', department: '华北区' },
        { name: '吴小十五', department: '华北区' },
        // 华中区
        { name: '郑小十六', department: '华中区' },
        { name: '王小十七', department: '华中区' },
        { name: '李小十八', department: '华中区' },
        { name: '张小十九', department: '华中区' },
        { name: '刘小二十', department: '华中区' },
        { name: '陈小二十一', department: '华中区' },
        { name: '赵小二十二', department: '华中区' },
        { name: '孙小二十三', department: '华中区' },
        { name: '周小二十四', department: '华中区' },
        { name: '吴小二十五', department: '华中区' },
        { name: '钱小二十六', department: '华中区' },
        { name: '黄小二十七', department: '华中区' },
        // 西南区
        { name: '李小二十八', department: '西南区' },
        { name: '张小二十九', department: '西南区' },
        { name: '刘小三十', department: '西南区' },
        // 西北区
        { name: '陈小三十一', department: '西北区' },
        { name: '赵小三十二', department: '西北区' },
        { name: '孙小三十三', department: '西北区' },
        // 运营部
        { name: '周小三十四', department: '运营部' },
        { name: '吴小三十五', department: '运营部' },
        // 教学部
        { name: '郑小三十六', department: '教学部' }
    ];

    salesTeam = staffData.map((staff, index) => ({
        id: index + 1,
        name: staff.name,
        weight: 10, // 默认权重为10
        department: staff.department,
        level: calculateLevel(10), // L1级（权重10 < 15）
        currentWeight: 0,
        leadCount: 0,
        ...generateRandomPerformance()
    }));
    
    // 默认按部门排序
    sortConfig.column = 'department';
    sortConfig.direction = 'asc';
    applySorting();
}

let leadCounter = 0;
let logs = [];
let sortConfig = { column: null, direction: null }; // 排序配置：column和direction
let statusSortConfig = { column: 'weight', direction: 'desc' }; // 右侧分配状态表格的排序配置，默认按设定权重降序
let currentView = 'flat'; // 当前视图模式：'flat' 或 'group'
let isCollapsed = false; // 是否处于折叠状态

// 计算权重百分比
function calculatePercentages() {
    if (salesTeam.length === 0) return [];
    
    const totalWeight = salesTeam.reduce((sum, user) => sum + user.weight, 0);
    const percentages = [];
    let accumulatedPercentage = 0;
    
    // 计算前n-1个用户的百分比
    for (let i = 0; i < salesTeam.length - 1; i++) {
        const percentage = (salesTeam[i].weight / totalWeight) * 100;
        percentages.push(percentage);
        accumulatedPercentage += percentage;
    }
    
    // 最后一个用户的百分比 = 100% - 前面所有用户的百分比总和
    if (salesTeam.length > 0) {
        percentages.push(100 - accumulatedPercentage);
    }
    
    return percentages;
}

// 平滑加权轮询算法 - 核心实现
function assignLead() {
    if (salesTeam.length === 0) return null;
    
    let bestCandidate = null;
    let totalWeight = 0;
    
    // 1. 更新每个销售的当前权重，找出最大权重者
    salesTeam.forEach(user => {
        user.currentWeight += user.weight;
        totalWeight += user.weight;
        
        if (!bestCandidate || user.currentWeight > bestCandidate.currentWeight) {
            bestCandidate = user;
        }
    });
    
    // 2. 减少被选中者的当前权重
    if (bestCandidate) {
        bestCandidate.currentWeight -= totalWeight;
        bestCandidate.leadCount++;
        leadCounter++;
        
        // 3. 记录日志
        logs.unshift({
            id: leadCounter,
            assignee: bestCandidate.name,
            timestamp: new Date().toLocaleTimeString(),
            userId: bestCandidate.id
        });
        
        if (logs.length > 50) logs.pop(); // 保持日志长度
    }
    
    return bestCandidate;
}

// 模拟分配
function simulate(count) {
    for (let i = 0; i < count; i++) {
        assignLead();
    }
    renderAll();
}

// 重置统计
function reset() {
    salesTeam.forEach(user => {
        user.currentWeight = 0;
        user.leadCount = 0;
    });
    leadCounter = 0;
    logs = [];
    renderAll();
}

// 添加销售
function addUser() {
    const newId = Math.max(...salesTeam.map(u => u.id), 0) + 1;
    const defaultWeight = 10;
    salesTeam.push({
        id: newId,
        name: `销售${newId}`,
        weight: defaultWeight,
        department: '销售一部',
        level: calculateLevel(defaultWeight),
        currentWeight: 0,
        leadCount: 0,
        ...generateRandomPerformance()
    });
    renderAll();
}

// 删除销售
function removeUser(id) {
    salesTeam = salesTeam.filter(user => user.id !== id);
    renderAll();
}

// 更新销售信息
function updateUser(id, field, value) {
    const user = salesTeam.find(u => u.id === id);
    if (user) {
        if (field === 'weight') {
            const weight = parseFloat(value);
            if (weight >= 1 && weight <= 100) {
                user[field] = weight;
                // 权重改变时自动更新职级
                user.level = calculateLevel(weight);
            }
        } else {
            user[field] = value;
        }
        renderAll();
    }
}

// 显示员工卡片
function showStaffCard(event, user) {
    // 隐藏所有其他卡片
    document.querySelectorAll('.staff-card').forEach(card => {
        card.classList.remove('show');
    });
    
    const card = document.getElementById(`staff-card-${user.id}`);
    if (card) {
        const rect = event.target.getBoundingClientRect();
        
        // 先设置transform为none，避免动画冲突
        card.style.transform = 'none';
        
        // 基于姓名位置向右偏移80px
        let leftPos = rect.left + 80;
        let topPos = rect.top + window.scrollY;
        
        // 检查是否超出右边界，如果超出则调整位置
        if (leftPos + 280 > window.innerWidth) { // 卡片宽度280px
            leftPos = window.innerWidth - 280 - 20; // 确保不超出窗口，留20px边距
        }
        
        // 检查是否超出左边界
        if (leftPos < 20) {
            leftPos = 20; // 最小左边距
        }
        
        // 设置位置
        card.style.left = leftPos + 'px';
        card.style.top = topPos + 'px';
        
        // 最后显示卡片
        card.classList.add('show');
    }
}

// 隐藏员工卡片
function hideStaffCard(user) {
    const card = document.getElementById(`staff-card-${user.id}`);
    if (card) {
        card.classList.remove('show');
    }
}

// 视图切换功能
function switchView(viewType) {
    currentView = viewType;
    
    // 更新按钮样式
    const flatBtn = document.getElementById('flat-view-btn');
    const groupBtn = document.getElementById('group-view-btn');
    const collapseBtn = document.getElementById('toggle-collapse-btn');
    
    if (viewType === 'flat') {
        flatBtn.className = 'px-3 py-1 rounded-md text-sm transition-all duration-200 bg-blue-500 text-white';
        groupBtn.className = 'px-3 py-1 rounded-md text-sm transition-all duration-200 text-gray-600 hover:bg-gray-200';
        // 平铺视图下隐藏折叠按钮
        collapseBtn.classList.add('hidden');
        isCollapsed = false;
    } else {
        flatBtn.className = 'px-3 py-1 rounded-md text-sm transition-all duration-200 text-gray-600 hover:bg-gray-200';
        groupBtn.className = 'px-3 py-1 rounded-md text-sm transition-all duration-200 bg-blue-500 text-white';
        // 分组视图下显示折叠按钮
        collapseBtn.classList.remove('hidden');
        updateCollapseButtonText();
    }
    
    // 更新表头样式
    const deptHeader = document.getElementById('department-header');
    if (viewType === 'group') {
        // 分组视图下，部门列不可排序
        deptHeader.className = 'p-3 text-center text-gray-400';
        deptHeader.onclick = null;
    } else {
        // 平铺视图下，部门列可排序
        deptHeader.className = 'p-3 text-center cursor-pointer hover:bg-gray-100';
        deptHeader.onclick = () => sortTable('department');
    }
    
    // 重新渲染表格
    renderTeamTable();
}

// 切换折叠状态
function toggleCollapse() {
    isCollapsed = !isCollapsed;
    updateCollapseButtonText();
    renderTeamTable();
}

// 更新折叠按钮文本
function updateCollapseButtonText() {
    const collapseBtn = document.getElementById('toggle-collapse-btn');
    if (isCollapsed) {
        collapseBtn.innerHTML = '📋 详细列表';
        collapseBtn.className = 'bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 text-sm';
    } else {
        collapseBtn.innerHTML = '📊 部门概览';
        collapseBtn.className = 'bg-purple-500 text-white px-3 py-1 rounded-lg hover:bg-purple-600 text-sm';
    }
}

// 渲染团队配置表格
function renderTeamTable() {
    const percentages = calculatePercentages();
    const tbody = document.getElementById('team-table');
    
    if (currentView === 'flat') {
        // 平铺视图 - 原有逻辑
        tbody.innerHTML = salesTeam.map((user, index) => `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-3 font-medium text-gray-900">
                    <span class="staff-name-hover"
                          onmouseenter="showStaffCard(event, ${JSON.stringify(user).replace(/"/g, '&quot;')})"
                          onmouseleave="hideStaffCard(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                        ${user.name}
                    </span>
                </td>
                <td class="p-3 text-center text-orange-600 font-semibold">${user.department}</td>
                <td class="p-3 text-center text-purple-600 font-semibold">${user.level}</td>
                <td class="p-3 text-center">
                    <input type="number" value="${user.weight}" step="1" min="1" max="100"
                           onchange="updateUser(${user.id}, 'weight', this.value)"
                           class="w-24 p-2 border rounded text-center text-blue-600 font-semibold bg-white text-sm">
                </td>
                <td class="p-3 text-center">
                    <span class="font-semibold ${index === salesTeam.length - 1 ? 'text-red-600' : 'text-blue-600'}">
                        ${percentages[index]?.toFixed(1) || 0}%
                    </span>
                    ${index === salesTeam.length - 1 ? '<div class="text-xs text-red-500">(自动调整)</div>' : ''}
                </td>
                <td class="p-3 text-center">
                    <button onclick="removeUser(${user.id})" 
                            class="text-red-500 hover:text-red-700 p-2 rounded hover:bg-red-50 font-bold" 
                            title="删除">
                        ×
                    </button>
                </td>
            </tr>
        `).join('');
    } else {
        // 分组视图 - 按部门分组
        const departments = ['销售一部', '销售二部', '华北区', '华中区', '西南区', '西北区', '运营部', '教学部'];
        let groupedHTML = '';
        
        if (isCollapsed) {
            // 折叠模式：只显示部门统计
            departments.forEach(dept => {
                const deptUsers = salesTeam.filter(user => user.department === dept);
                if (deptUsers.length === 0) return;
                
                // 计算部门统计
                const deptTotalWeight = deptUsers.reduce((sum, user) => sum + user.weight, 0);
                const deptTotalLeads = deptUsers.reduce((sum, user) => sum + user.leadCount, 0);
                const deptAvgWeight = deptUsers.length > 0 ? (deptTotalWeight / deptUsers.length).toFixed(1) : 0;
                const levelStats = deptUsers.reduce((stats, user) => {
                    stats[user.level] = (stats[user.level] || 0) + 1;
                    return stats;
                }, {});
                
                const levelStatsText = Object.entries(levelStats)
                    .map(([level, count]) => `${level}:${count}`)
                    .join(' | ');
                
                // 部门概览行
                groupedHTML += `
                    <tr class="bg-gradient-to-r from-blue-50 to-purple-50 border-b-2 border-blue-200 hover:from-blue-100 hover:to-purple-100">
                        <td class="p-4 font-bold text-gray-900 text-lg">
                            <div class="flex items-center">
                                <span class="text-orange-600 mr-2">📊</span>
                                <span>${dept}</span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-sm font-semibold">
                                ${deptUsers.length}人
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="text-purple-600 font-semibold text-sm">
                                ${levelStatsText}
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="text-blue-600 font-semibold">
                                总计: ${deptTotalWeight}<br>
                                <span class="text-xs text-gray-500">平均: ${deptAvgWeight}</span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="text-green-600 font-semibold text-sm">
                                ${((deptTotalWeight / salesTeam.reduce((sum, user) => sum + user.weight, 0)) * 100).toFixed(1)}%
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-semibold">
                                ${deptTotalLeads}条
                            </div>
                        </td>
                    </tr>
                `;
            });
        } else {
            // 展开模式：显示详细人员信息
            departments.forEach(dept => {
                const deptUsers = salesTeam.filter(user => user.department === dept);
                if (deptUsers.length === 0) return;
                
                // 部门分组标题行
                groupedHTML += `
                    <tr class="bg-gray-100 border-b-2 border-gray-300">
                        <td colspan="6" class="p-3 font-bold text-gray-800 text-lg">
                            <span class="text-orange-600">${dept}</span> (${deptUsers.length}人)
                        </td>
                    </tr>
                `;
                
                // 该部门的员工行
                deptUsers.forEach((user, index) => {
                    const globalIndex = salesTeam.findIndex(u => u.id === user.id);
                    groupedHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3 font-medium text-gray-900 pl-8">
                                <span class="staff-name-hover"
                                      onmouseenter="showStaffCard(event, ${JSON.stringify(user).replace(/"/g, '&quot;')})"
                                      onmouseleave="hideStaffCard(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                                    ${user.name}
                                </span>
                            </td>
                            <td class="p-3 text-center text-orange-600 font-semibold">${user.department}</td>
                            <td class="p-3 text-center text-purple-600 font-semibold">${user.level}</td>
                            <td class="p-3 text-center">
                                <input type="number" value="${user.weight}" step="1" min="1" max="100"
                                       onchange="updateUser(${user.id}, 'weight', this.value)"
                                       class="w-24 p-2 border rounded text-center text-blue-600 font-semibold bg-white text-sm">
                            </td>
                            <td class="p-3 text-center">
                                <span class="font-semibold ${globalIndex === salesTeam.length - 1 ? 'text-red-600' : 'text-blue-600'}">
                                    ${percentages[globalIndex]?.toFixed(1) || 0}%
                                </span>
                                ${globalIndex === salesTeam.length - 1 ? '<div class="text-xs text-red-500">(自动调整)</div>' : ''}
                            </td>
                            <td class="p-3 text-center">
                                <button onclick="removeUser(${user.id})" 
                                        class="text-red-500 hover:text-red-700 p-2 rounded hover:bg-red-50 font-bold" 
                                        title="删除">
                                    ×
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });
        }
        
        tbody.innerHTML = groupedHTML;
    }
    
    // 添加员工卡片
    renderStaffCards();
}

// 渲染员工卡片
function renderStaffCards() {
    const existingCards = document.querySelectorAll('.staff-card');
    existingCards.forEach(card => card.remove());
    
    salesTeam.forEach(user => {
        const card = document.createElement('div');
        card.id = `staff-card-${user.id}`;
        card.className = 'staff-card';
        card.style.transform = 'none'; // 确保没有默认的transform
        card.innerHTML = `
            <div class="flex items-start gap-3 mb-3">
                <div class="avatar">
                    ${user.name.charAt(0)}
                </div>
                <div class="flex-1">
                    <h3 class="font-bold text-lg text-gray-900">${user.name}</h3>
                    <p class="text-sm text-gray-500">${user.department} · ${user.level}级</p>
                </div>
            </div>
            
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">本月业绩：</span>
                    <span class="font-semibold text-green-600">${user.monthlyPerformance}万</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">本月已成交：</span>
                    <span class="font-semibold text-blue-600">${user.monthlyDeals}单</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">本月新分线索：</span>
                    <span class="font-semibold text-purple-600">${user.monthlyLeads}条</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">动态转化率：</span>
                    <span class="font-semibold text-orange-600">${user.conversionRate}%</span>
                </div>
                <div class="pt-2 border-t">
                    <div class="text-gray-600 text-xs mb-1">所在分配组：</div>
                    <div class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs font-medium leading-relaxed">
                        ${user.assignGroup}
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(card);
    });
}

// 渲染状态面板
function renderStatus() {
    const tbody = document.getElementById('status-panel');
    
    // 获取排序后的团队数据
    let sortedTeam = [...salesTeam];
    
    if (statusSortConfig.column && statusSortConfig.direction) {
        sortedTeam.sort((a, b) => {
            let valueA = a[statusSortConfig.column];
            let valueB = b[statusSortConfig.column];
            
                            // 特殊处理部门排序
                if (statusSortConfig.column === 'department') {
                    const departmentOrder = { 
                        '销售一部': 1, '销售二部': 2, '华北区': 3, '华中区': 4, 
                        '西南区': 5, '西北区': 6, '运营部': 7, '教学部': 8 
                    };
                    valueA = departmentOrder[valueA] || 999;
                    valueB = departmentOrder[valueB] || 999;
                }
            // 特殊处理权重排序
            else if (statusSortConfig.column === 'weight') {
                valueA = parseFloat(valueA);
                valueB = parseFloat(valueB);
            }
            // 特殊处理线索占比排序
            else if (statusSortConfig.column === 'leadRatio') {
                const totalLeadCount = salesTeam.reduce((sum, user) => sum + user.leadCount, 0);
                valueA = totalLeadCount > 0 ? (a.leadCount / totalLeadCount * 100) : 0;
                valueB = totalLeadCount > 0 ? (b.leadCount / totalLeadCount * 100) : 0;
            }
            
            if (valueA < valueB) {
                return statusSortConfig.direction === 'asc' ? -1 : 1;
            }
            if (valueA > valueB) {
                return statusSortConfig.direction === 'asc' ? 1 : -1;
            }
            return 0;
        });
    }
    
    // 计算汇总数据
    const totalWeight = salesTeam.reduce((sum, user) => sum + user.weight, 0);
    const totalCurrentWeight = salesTeam.reduce((sum, user) => sum + user.currentWeight, 0);
    const totalLeadCount = salesTeam.reduce((sum, user) => sum + user.leadCount, 0);
    const userCount = salesTeam.length;
    
    const userRows = sortedTeam.map(user => {
        const isLastAssigned = logs.length > 0 && logs[0].userId === user.id;
        const weightPercentage = totalWeight > 0 ? (user.weight / totalWeight * 100).toFixed(1) : '0.0';
        const leadRatio = totalLeadCount > 0 ? (user.leadCount / totalLeadCount * 100).toFixed(1) : '0.0';
        
        return `
            <tr class="border-b ${isLastAssigned ? 'highlight bg-yellow-50' : 'hover:bg-gray-50'}">
                <td class="p-3 font-medium text-gray-900">
                    <span class="staff-name-hover"
                          onmouseenter="showStaffCard(event, ${JSON.stringify(user).replace(/"/g, '&quot;')})"
                          onmouseleave="hideStaffCard(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                        ${user.name}
                    </span>
                </td>
                <td class="p-3 text-center text-orange-600 font-semibold">${user.department}</td>
                <td class="p-3 text-center text-purple-600 font-semibold">${user.level}</td>
                <td class="p-3 text-center text-blue-600 font-semibold text-sm">${user.weight} (${weightPercentage}%)</td>
                <td class="p-3 text-center font-mono text-sm ${user.currentWeight >= 0 ? 'text-green-600' : 'text-red-600'}">${Math.round(user.currentWeight)}</td>
                <td class="p-3 text-center font-bold text-blue-700">${user.leadCount}</td>
                <td class="p-3 text-center font-bold text-purple-700">
                    ${leadRatio}%
                </td>
            </tr>
        `;
    }).join('');
    
    // 汇总行
    const summaryRow = `
        <tr class="border-t-2 border-gray-400 bg-blue-50 font-semibold">
            <td class="p-3 font-bold text-gray-900">汇总 (${userCount}人)</td>
            <td class="p-3 text-center text-gray-600">-</td>
            <td class="p-3 text-center text-gray-600">-</td>
            <td class="p-3 text-center font-bold text-blue-700 text-sm">${totalWeight.toFixed(1)} (100%)</td>
            <td class="p-3 text-center font-bold font-mono text-sm ${totalCurrentWeight >= 0 ? 'text-green-700' : 'text-red-700'}">${Math.round(totalCurrentWeight)}</td>
            <td class="p-3 text-center font-bold text-blue-700">${totalLeadCount}</td>
            <td class="p-3 text-center font-bold text-purple-700">
                100%
            </td>
        </tr>
    `;
    
    tbody.innerHTML = userRows + summaryRow;
}

// 渲染日志
function renderLogs() {
    const panel = document.getElementById('log-panel');
    
    if (logs.length === 0) {
        panel.innerHTML = '<p class="text-gray-500 text-center">暂无分配记录</p>';
        return;
    }
    
    panel.innerHTML = logs.map(log => `
        <div class="mb-2 p-2 bg-white rounded border-l-4 border-blue-500">
            <span class="font-medium">线索 #${log.id}</span> → 
            <span class="text-blue-600 font-semibold">${log.assignee}</span>
            <span class="text-gray-400 text-sm float-right">${log.timestamp}</span>
        </div>
    `).join('');
    
    panel.scrollTop = 0;
}

// 应用排序的核心函数
function applySorting() {
    let sortedTeam = [...salesTeam];
    
    if (currentView === 'group') {
        // 分组视图：在各部门内部排序
        if (sortConfig.column && sortConfig.direction && sortConfig.column !== 'department') {
            const departments = ['销售一部', '销售二部', '华北区', '华中区', '西南区', '西北区', '运营部', '教学部'];
            let newSortedTeam = [];
            
            departments.forEach(dept => {
                const deptUsers = sortedTeam.filter(user => user.department === dept);
                if (deptUsers.length === 0) return;
                
                deptUsers.sort((a, b) => {
                    let valueA = a[sortConfig.column];
                    let valueB = b[sortConfig.column];
                    
                    if (sortConfig.column === 'level') {
                        const levelOrder = { 'L1': 1, 'L2': 2, 'L3': 3 };
                        valueA = levelOrder[valueA] || 999;
                        valueB = levelOrder[valueB] || 999;
                    } else if (typeof valueA === 'string') {
                        valueA = valueA.toLowerCase();
                        valueB = valueB.toLowerCase();
                    }
                    
                    if (valueA < valueB) {
                        return sortConfig.direction === 'asc' ? -1 : 1;
                    }
                    if (valueA > valueB) {
                        return sortConfig.direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
                
                newSortedTeam.push(...deptUsers);
            });
            
            sortedTeam = newSortedTeam;
        } else {
            // 分组视图下默认按部门+ID排序
            const departments = ['销售一部', '销售二部', '华北区', '华中区', '西南区', '西北区', '运营部', '教学部'];
            let newSortedTeam = [];
            departments.forEach(dept => {
                const deptUsers = sortedTeam.filter(user => user.department === dept);
                deptUsers.sort((a, b) => a.id - b.id);
                newSortedTeam.push(...deptUsers);
            });
            sortedTeam = newSortedTeam;
        }
    } else {
        // 平铺视图：全局排序
        if (sortConfig.column && sortConfig.direction) {
            sortedTeam.sort((a, b) => {
                let valueA = a[sortConfig.column];
                let valueB = b[sortConfig.column];
                
                // 特殊处理部门排序
                if (sortConfig.column === 'department') {
                    const departmentOrder = { 
                        '销售一部': 1, '销售二部': 2, '华北区': 3, '华中区': 4, 
                        '西南区': 5, '西北区': 6, '运营部': 7, '教学部': 8 
                    };
                    valueA = departmentOrder[valueA] || 999;
                    valueB = departmentOrder[valueB] || 999;
                } else if (sortConfig.column === 'level') {
                    // 特殊处理职级排序
                    const levelOrder = { 'L1': 1, 'L2': 2, 'L3': 3 };
                    valueA = levelOrder[valueA] || 999;
                    valueB = levelOrder[valueB] || 999;
                } else if (typeof valueA === 'string') {
                    // 处理其他字符串类型的排序
                    valueA = valueA.toLowerCase();
                    valueB = valueB.toLowerCase();
                }
                
                if (valueA < valueB) {
                    return sortConfig.direction === 'asc' ? -1 : 1;
                }
                if (valueA > valueB) {
                    return sortConfig.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        } else {
            // 如果没有排序配置，则按ID排序（默认顺序）
            sortedTeam.sort((a, b) => a.id - b.id);
        }
    }
    
    salesTeam = sortedTeam;
}

// 表格排序功能
function sortTable(column) {
    // 在分组视图下，不允许按部门排序（因为已经按部门分组）
    if (currentView === 'group' && column === 'department') {
        return;
    }
    
    // 如果点击的是当前排序列，则切换排序方向
    if (sortConfig.column === column) {
        if (sortConfig.direction === 'asc') {
            sortConfig.direction = 'desc';
        } else if (sortConfig.direction === 'desc') {
            sortConfig.direction = null;
            sortConfig.column = null;
        } else {
            sortConfig.direction = 'asc';
        }
    } else {
        // 如果点击的是新列，则设置为升序
        sortConfig.column = column;
        sortConfig.direction = 'asc';
    }
    
    applySorting();
    updateSortIndicators();
    renderAll();
}

// 分配状态表格排序功能
function sortStatusTable(column) {
    // 如果点击的是当前排序列，则切换排序方向
    if (statusSortConfig.column === column) {
        if (statusSortConfig.direction === 'asc') {
            statusSortConfig.direction = 'desc';
        } else if (statusSortConfig.direction === 'desc') {
            statusSortConfig.direction = null;
            statusSortConfig.column = null;
        } else {
            statusSortConfig.direction = 'asc';
        }
    } else {
        // 如果点击的是新列，则设置为升序
        statusSortConfig.column = column;
        statusSortConfig.direction = 'asc';
    }
    
    updateStatusSortIndicators();
    renderStatus();
}

// 更新左侧团队配置排序指示器
function updateSortIndicators() {
    const indicators = ['name', 'department', 'level', 'weight'];
    
    indicators.forEach(indicator => {
        const element = document.getElementById(`sort-${indicator}`);
        if (element) {
            // 在分组视图下，部门列不显示排序指示器（因为已经按部门分组）
            if (currentView === 'group' && indicator === 'department') {
                element.textContent = '';
                return;
            }
            
            if (sortConfig.column === indicator) {
                if (sortConfig.direction === 'asc') {
                    element.textContent = '↑';
                    element.style.color = '#3b82f6';
                } else if (sortConfig.direction === 'desc') {
                    element.textContent = '↓';
                    element.style.color = '#3b82f6';
                }
            } else {
                element.textContent = '⇅';
                element.style.color = '#9ca3af';
            }
        }
    });
}

// 更新右侧分配状态排序指示器
function updateStatusSortIndicators() {
    const indicators = ['department', 'weight', 'leadCount', 'leadRatio'];
    
    indicators.forEach(indicator => {
        const element = document.getElementById(`status-sort-${indicator}`);
        if (element) {
            if (statusSortConfig.column === indicator) {
                if (statusSortConfig.direction === 'asc') {
                    element.textContent = '↑';
                    element.style.color = '#3b82f6';
                } else if (statusSortConfig.direction === 'desc') {
                    element.textContent = '↓';
                    element.style.color = '#3b82f6';
                }
            } else {
                element.textContent = '⇅';
                element.style.color = '#9ca3af';
            }
        }
    });
}

// 渲染所有组件
function renderAll() {
    renderTeamTable();
    renderStatus();
    renderLogs();
    updateSortIndicators();
    updateStatusSortIndicators();
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    initializeSalesTeam(); // 初始化销售团队数据
    document.getElementById('add-user').addEventListener('click', addUser);
    renderAll();
});

// 点击页面其他地方隐藏所有卡片
document.addEventListener('click', (event) => {
    if (!event.target.closest('.staff-name-hover') && !event.target.closest('.staff-card')) {
        document.querySelectorAll('.staff-card').forEach(card => {
            card.classList.remove('show');
        });
    }
});
</script>

</body>
</html> 